# mockd.yaml - MQTT IoT Template
# Generated by: mockd init --template mqtt-iot
# Documentation: https://mockd.io/docs
#
# This template provides an MQTT broker for IoT simulation with:
# - Temperature sensor topic
# - Humidity sensor topic
# - Command/response topics
# - Device simulation
#
# Start server: mockd serve --config mockd.yaml
# Test: mosquitto_sub -h localhost -p 1883 -t "sensors/#"

version: "1.0"

mocks:
  # MQTT IoT Broker
  - id: mqtt-mqtt-iot-broker
    name: IoT MQTT Broker
    type: mqtt
    enabled: true
    mqtt:
      # MQTT broker port
      port: 1883
      # Authentication (optional)
      auth:
        enabled: false
        users:
          - username: device
            password: secret123
            acl:
              - topic: "sensors/#"
                access: publish
              - topic: "commands/#"
                access: subscribe
          - username: admin
            password: admin123
            acl:
              - topic: "#"
                access: all
      # Topic configurations
      topics:
        # Temperature sensor topic
        # Publishes simulated temperature readings
        - topic: sensors/temperature
          qos: 1
          retain: true
          messages:
            - payload: |
                {
                  "deviceId": "temp_001",
                  "type": "temperature",
                  "value": {{randomInt 18 28}},
                  "unit": "celsius",
                  "timestamp": "{{now}}"
                }
              interval: "5s"
              repeat: true

        # Humidity sensor topic
        # Publishes simulated humidity readings
        - topic: sensors/humidity
          qos: 1
          retain: true
          messages:
            - payload: |
                {
                  "deviceId": "humid_001",
                  "type": "humidity",
                  "value": {{randomInt 40 80}},
                  "unit": "percent",
                  "timestamp": "{{now}}"
                }
              interval: "5s"
              repeat: true

        # Motion sensor topic
        - topic: sensors/motion
          qos: 0
          messages:
            - payload: |
                {
                  "deviceId": "motion_001",
                  "type": "motion",
                  "detected": true,
                  "zone": "entrance",
                  "timestamp": "{{now}}"
                }
              interval: "30s"
              repeat: true

        # Device status topic
        - topic: devices/status
          qos: 1
          retain: true
          messages:
            - payload: |
                {
                  "deviceId": "gateway_001",
                  "status": "online",
                  "uptime": {{randomInt 1000 50000}},
                  "firmware": "1.2.3",
                  "timestamp": "{{now}}"
                }
              delay: "1s"

        # Command topic - listens for commands and responds
        - topic: commands/device/+
          qos: 1
          onPublish:
            # Respond to commands on a response topic
            response:
              payload: |
                {
                  "status": "acknowledged",
                  "command": "{{message.payload}}",
                  "executedAt": "{{now}}"
                }
            forward: responses/device

        # Alert topic
        - topic: alerts/+
          qos: 2
          retain: true

        # Device simulation - multiple virtual devices
        - topic: sensors/device/+/telemetry
          qos: 1
          deviceSimulation:
            enabled: true
            deviceCount: 5
            deviceIdPattern: "device_{index}"

  # HTTP endpoint for MQTT info and status
  - id: mqtt-mqtt-info
    name: MQTT Broker Info
    type: http
    enabled: true
    http:
      matcher:
        method: GET
        path: /mqtt/info
      response:
        statusCode: 200
        headers:
          Content-Type: application/json
        body: |
          {
            "broker": {
              "port": 1883,
              "protocol": "mqtt",
              "authentication": false
            },
            "topics": {
              "sensors": {
                "temperature": "sensors/temperature",
                "humidity": "sensors/humidity",
                "motion": "sensors/motion"
              },
              "commands": {
                "send": "commands/device/{deviceId}",
                "responses": "responses/device"
              },
              "status": "devices/status",
              "alerts": "alerts/{type}"
            },
            "subscription_examples": {
              "all_sensors": "sensors/#",
              "all_commands": "commands/#",
              "specific_device": "sensors/device/device_001/telemetry"
            }
          }

  # HTTP health check
  - id: mqtt-health-check
    name: Health Check
    type: http
    enabled: true
    http:
      matcher:
        method: GET
        path: /health
      response:
        statusCode: 200
        headers:
          Content-Type: application/json
        body: |
          {"status": "ok", "mqtt_port": 1883}

# Next steps:
# 1. Run: mockd serve --config mockd.yaml
# 2. Install mosquitto clients:
#    - Ubuntu/Debian: apt install mosquitto-clients
#    - macOS: brew install mosquitto
# 3. Subscribe to all sensors:
#    mosquitto_sub -h localhost -p 1883 -t "sensors/#" -v
# 4. Subscribe to specific topic:
#    mosquitto_sub -h localhost -p 1883 -t "sensors/temperature"
# 5. Publish a command:
#    mosquitto_pub -h localhost -p 1883 -t "commands/device/001" -m '{"action": "restart"}'
# 6. Watch responses:
#    mosquitto_sub -h localhost -p 1883 -t "responses/#" -v
# 7. For authentication, enable auth and use:
#    mosquitto_sub -h localhost -p 1883 -u device -P secret123 -t "sensors/#"
# 8. Customize topics, intervals, and payloads for your IoT scenario
