# Test runner image: Alpine with bats-core, protocol clients, and mockd CLI.
#
# Uses bats-core as the test framework for E2E tests against a remote
# mockd server. Multi-stage build: first builds mockd, then copies it
# into the runner alongside bats and protocol clients.
#
# Usage:
#   bats /e2e/suites/                          # run all suites
#   bats /e2e/suites/grpc_protocol.bats        # run one suite
#   bats /e2e/suites/ --filter "GRPC"          # filter by name
#   bats /e2e/suites/ --formatter junit        # JUnit XML output

# Stage 1: Build mockd (same as Dockerfile.mockd)
FROM golang:1.25.7-alpine AS builder

RUN apk add --no-cache ca-certificates git

WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download && go mod verify
COPY . .

RUN CGO_ENABLED=0 go build \
    -ldflags="-s -w" \
    -trimpath \
    -o mockd \
    ./cmd/mockd

# Stage 2: Test runner with bats + mockd binary + protocol clients
FROM alpine:3.20

RUN apk add --no-cache \
    bash \
    curl \
    jq \
    coreutils \
    git \
    mosquitto-clients \
    websocat

# Install bats-core from source (no npm dependency)
RUN git clone --depth 1 --branch v1.11.1 https://github.com/bats-core/bats-core.git /tmp/bats-core && \
    /tmp/bats-core/install.sh /usr/local && \
    rm -rf /tmp/bats-core

# Install grpcurl (not in Alpine repos)
RUN curl -sSL https://github.com/fullstorydev/grpcurl/releases/download/v1.9.3/grpcurl_1.9.3_linux_x86_64.tar.gz \
    | tar -xz -C /usr/local/bin grpcurl && chmod +x /usr/local/bin/grpcurl

# Copy the built mockd binary for CLI tests
COPY --from=builder /build/mockd /usr/local/bin/mockd

# Copy test fixtures needed by protocol tests
COPY tests/fixtures/grpc/test.proto /fixtures/test.proto

# Copy bats test suites and helpers
COPY tests/e2e/lib/ /e2e/lib/
COPY tests/e2e/suites/ /e2e/suites/

ENTRYPOINT ["bats", "--formatter", "tap", "/e2e/suites/"]
