# mockd E2E Test Stack
#
# Architecture:
#   mockd:        Admin API (:4290) + Mock Engine (:4280) — the system under test
#   test-runner:  Alpine + bats-core + protocol clients + mockd CLI — runs bats suites
#
# Usage:
#   docker compose -f tests/e2e/docker-compose.yml up --build --abort-on-container-exit
#
# Run specific suites:
#   docker compose -f tests/e2e/docker-compose.yml run test-runner \
#     bats /e2e/suites/grpc_protocol.bats /e2e/suites/mqtt_protocol.bats
#
# Filter by test name:
#   docker compose -f tests/e2e/docker-compose.yml run test-runner \
#     bats --filter "GRPC" /e2e/suites/
#
# The test-runner exits 0 on success, non-zero on failure.
# --abort-on-container-exit ensures compose stops when tests finish.

services:
  mockd:
    build:
      context: ../..
      dockerfile: tests/e2e/Dockerfile.mockd
    container_name: mockd-e2e
    command:
      - serve
      - --port=4280
      - --admin-port=4290
      - --data-dir=/tmp/mockd-e2e
      - --log-level=warn
      - --no-auth
    ports:
      - "14280:4280"
      - "14290:4290"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4290/health"]
      interval: 2s
      timeout: 3s
      start_period: 5s
      retries: 10
    networks:
      - test-net
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 512M

  test-runner:
    build:
      context: ../..
      dockerfile: tests/e2e/Dockerfile.runner
    container_name: mockd-e2e-runner
    depends_on:
      mockd:
        condition: service_healthy
    environment:
      MOCKD_ADMIN_URL: http://mockd:4290
      MOCKD_ENGINE_URL: http://mockd:4280
    volumes:
      - test-results:/results
    networks:
      - test-net

volumes:
  test-results:

networks:
  test-net:
    driver: bridge
